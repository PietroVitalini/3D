<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sketchfab 3D Configurator — Final Prototype v13.2</title>
  <style>
    :root{ --bg:#070b14; --panel:#0d1426; --panel-2:#0b1120; --text:#e8ecf6; --muted:#9aa5b3; --accent:#7dd3fc; --border:#1a2444; --danger:#ef4444 }
    *{box-sizing:border-box}
    html,body{height:100%; overflow:hidden}
    body{margin:0;background:radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.12), transparent),
                     radial-gradient(1200px 800px at 110% 110%, rgba(125,211,252,.10), transparent),
                     var(--bg);color:var(--text);font:15px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;height:100vh}
    .panel{height:100vh;overflow-y:auto;padding:20px 16px 24px;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-left:1px solid var(--border)}
    .panel h1{margin:0 0 10px;font-size:18px;letter-spacing:.2px}
    .group{border:1px solid var(--border);border-radius:16px;padding:12px 12px 14px;margin:12px 0;background:#0b1326}
    .group h2{font-size:13px;color:var(--muted);margin:0 0 10px;font-weight:600;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap}
    label{min-width:92px;color:var(--muted)}
    select, input[type="text"], input[type="email"], textarea{width:100%}
    textarea#prompt{width:100%;display:block;resize:none;min-height:100px;border:1px solid var(--border);border-radius:12px;background:#0a1222;color:var(--text);padding:12px;outline:none;overflow:auto;scrollbar-width:none;-ms-overflow-style:none}
    textarea#prompt::-webkit-scrollbar{width:0;height:0}
    button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0a1222;color:var(--text);cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .viewer{height:100vh}
    iframe{width:100%;height:100%;border:0;border-left:1px solid var(--border);background:transparent}

    /* Modern selects */
    select{appearance:none;-webkit-appearance:none;background:#0a1222;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 36px 10px 12px;line-height:1.2;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path d="M5 7l5 6 5-6" fill="none" stroke="%239aa5b3" stroke-width="2"/></svg>');background-repeat:no-repeat;background-position:right 10px center}
    select:focus{outline:none;box-shadow:0 0 0 2px rgba(125,211,252,.35);border-color:var(--accent)}

    /* Full-width primary actions */
    #genBtn,#dlBtn{display:block;width:100%}

    /* Nav row (arrows + index) */
    .navRow{display:grid;grid-template-columns:1fr 140px 1fr;gap:8px;align-items:center}
    #prevBtn,#nextBtn{width:100%}
    /* Make arrows look crisp and centered */
    .navRow button{height:44px;display:flex;align-items:center;justify-content:center;font-size:16px;border-radius:10px}
    #indexBox{width:100%;height:44px;text-align:center;border:1px solid var(--border);border-radius:10px;background:#0a1222;color:var(--text);padding:0 8px;font-weight:700;letter-spacing:.3px}

    /* Color rows layout */
    #colorsContainer .row{ justify-content: space-between; }
    #colorsContainer .row label{ flex:1 }

    /* ===== Palette-Limited Color Picker (dark theme) ===== */
    .cp{width:220px;position:relative}
    .cp .t,.cp .i{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:10px}
    .cp .t{cursor:pointer;background:#0a1222;color:var(--text)}
    .cp .c{opacity:.7;transition:transform .15s ease}
    .cp.open .c{transform:rotate(180deg)}
    .cp .s{width:16px;height:16px;border-radius:5px;box-shadow:inset 0 0 0 1px #0001}
    .cp .p{position:absolute;left:0;right:0;top:calc(100% + 8px);background:#0a1222;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 20px #0005;max-height:220px;overflow:auto;display:none}
    .cp .p.top{top:auto;bottom:calc(100% + 8px)}
    .cp .i{margin:6px}
    .cp .i:hover{background:#0d1426}

    /* Loading state */
    .button--loading{ position:relative; pointer-events:none; padding-right:36px }
    /* Spinner inside the button (right side) */
    .button--loading::after{ content:""; position:absolute; right:12px; top:50%; transform:translateY(-50%); width:16px; height:16px; border-radius:50%; border:2px solid var(--muted); border-top-color:transparent; animation:spin .8s linear infinite }
    @keyframes spin{ to{ transform:translateY(-50%) rotate(360deg) } }

    .error{ color:var(--danger); font-size:12px; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>3D Configurator</h1>

      <!-- Model selector -->
      <div class="group">
        <h2>Model</h2>
        <div class="row">
          <label for="typeSelect">Type</label>
          <select id="typeSelect"></select>
        </div>
        <div class="row">
          <label for="modelSelect">Model</label>
          <select id="modelSelect"></select>
        </div>
      </div>

      <div class="group">
        <h2>Describe your design…</h2>
        <div class="row" style="display:block">
          <textarea id="prompt" rows="5" placeholder="Describe your ideal design in natural language (e.g., minimal geometric pattern in navy and white, subtle fabric texture)…"></textarea>
        </div>
        <div class="row">
          <button id="genBtn">Generate</button>
        </div>
        <div class="row navRow">
          <button id="prevBtn" disabled>←</button>
          <input id="indexBox" type="text" value="0 / 0" readonly />
          <button id="nextBtn" disabled>→</button>
        </div>
        <div class="row">
          <button id="dlBtn" disabled>Download</button>
        </div>
        <div id="errorBox" class="error" style="display:none"></div>
        <div class="hint">History is per model. Reopening the site resumes on your latest design for the selected model.</div>
      </div>

      <div class="group" id="colorsGroup" style="display:none">
        <h2>Colors</h2>
        <div id="colorsContainer"></div>
        <div class="hint">Picking a color clears texture on that material.</div>
      </div>
    </div>

    <div class="viewer">
      <iframe id="api-frame" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="about:blank"></iframe>
    </div>
  </div>

  <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
  <script>
    // ====== CONFIG ======
    const API_BASE       = 'https://google.faster-551.workers.dev'; // backend
    const BASE_IMAGE_URL = 'https://raw.githubusercontent.com/PietroVitalini/vitalini-designer/refs/heads/main/assets/models/VP9655Bianca5.png';
    const PREPROMPT      = 'Create Image texture, keep 1:1 shape and size. each parts design should be self contained, keep in mind that the final product will not be as clear as the 2d reppresentation. User design request: ';

    const CATALOG = {
      'Jackets': [
        {
          id: 'VP9655', name: 'VP9655', uid: 'eea360f7606149deaf75345b1df3f519',
          designMat: 'Giacca1_FRONT_2563',
          colors: [ { label: 'Contrast', material: 'Contrasto_FRONT_2545' } ]
        }
      ],
      'Race suits': [ /* none yet → should blank viewer & hide colors */ ],
      'Ski pants':  [ /* add later */ ],
      'Vests':      [ /* add later */ ]
    };

    // ====== LIMITED PALETTE ======
    const LIMITED_COLORS = [
      { n:'white',        v:'#FFFFFF' },
      { n:'antracite',    v:'#394D55' },
      { n:'grey',         v:'#ABACAA' },
      { n:'dark blue',    v:'#00183F' },
      { n:'capri',        v:'#283484' },
      { n:'marine',       v:'#0966A7' },
      { n:'azzurro',      v:'#00B4DC' },
      { n:'amalfi',       v:'#08A8AC' },
      { n:'verde',        v:'#027039' },
      { n:'verde oliva',  v:'#6D7E27' },
      { n:'verde acido',  v:'#92F28C' },
      { n:'verde fluo',   v:'#93C55F' },
      { n:'purple',       v:'#822F8C' },
      { n:'amaranto',     v:'#A90056' },
      { n:'pink fluo',    v:'#EC008B' },
      { n:'limoncello',   v:'#DFE915' },
      { n:'limone',       v:'#FFF100' },
      { n:'sole',         v:'#F7DF18' },
      { n:'zafferano',    v:'#FFC507' },
      { n:'orange',       v:'#F37120' },
      { n:'red',          v:'#ED1B23' },
      { n:'burgundy',     v:'#84002C' }
    ];

    // ====== STATE ======
    let api = null;           // Sketchfab API handle
    let currentModel = null;  // model config
    let materialsByName = new Map();

    // DOM
    let iframe   = document.getElementById('api-frame');
    const typeSel  = document.getElementById('typeSelect');
    const modelSel = document.getElementById('modelSelect');

    const promptEl = document.getElementById('prompt');
    const genBtn   = document.getElementById('genBtn');
    const prevBtn  = document.getElementById('prevBtn');
    const nextBtn  = document.getElementById('nextBtn');
    const dlBtn    = document.getElementById('dlBtn');
    const indexBox = document.getElementById('indexBox');
    
    const errorBox = document.getElementById('errorBox');

    const colorsGroup = document.getElementById('colorsGroup');
    const colorsContainer = document.getElementById('colorsContainer');

    function showError(msg){ if(!errorBox) return; errorBox.textContent = msg; errorBox.style.display = 'block'; }
    function clearError(){ if(!errorBox) return; errorBox.textContent = ''; errorBox.style.display = 'none'; }

    // ====== UTIL ======
    const norm = s => (s||'').trim().toLowerCase();
    function baseColorChannel(mat){ const ch = mat.channels||{}; return ch.AlbedoPBR?'AlbedoPBR': ch.DiffusePBR?'DiffusePBR': ch.DiffuseColor?'DiffuseColor': ch.BaseColor?'BaseColor': ch.AlbedoColor?'AlbedoColor':'AlbedoPBR'; }
    function hexToRGBNorm(hex){ const h = hex.replace('#',''); const i = parseInt(h,16); return [((i>>16)&255)/255, ((i>>8)&255)/255, (i&255)/255]; }
    function rgbNormToHex(arr){ const toHex = v => ('0'+Math.max(0,Math.min(255,Math.round(v*255))).toString(16)).slice(-2); return `#${toHex(arr[0]||0)}${toHex(arr[1]||0)}${toHex(arr[2]||0)}`.toUpperCase(); }
    function findMaterial(name){ if(!name) return null; const exact = materialsByName.get(name); if(exact) return exact; const lname = norm(name); for(const [k,v] of materialsByName){ if(norm(k)===lname) return v; } for(const [k,v] of materialsByName){ if(norm(k).includes(lname)) return v; } return null; }

    function getHistKey(){ return currentModel ? `vd_hist_${currentModel.uid}` : 'vd_hist_none'; }
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(getHistKey())||'[]'); }catch{ return []; } }
    function saveHistory(arr){ try{ localStorage.setItem(getHistKey(), JSON.stringify(arr||[])); }catch{} }

    function updateIndexFromArr(arr){ const n = arr.length; indexBox.value = `${n} / ${n}`; prevBtn.disabled = n <= 1; nextBtn.disabled = true; dlBtn.disabled = n===0; }
    function applyHistoryIndex(n){ const arr = loadHistory(); const idx = Math.max(1, Math.min(n, arr.length)); const item = arr[idx-1]; if(!item) return; promptEl.value = item.prompt||''; applyTextureFromDataURL(currentModel.designMat, item.dataURL); indexBox.value = `${idx} / ${arr.length}`; prevBtn.disabled = idx<=1; nextBtn.disabled = idx>=arr.length; dlBtn.disabled = false; }
    function hydrateLatest(){ const arr = loadHistory(); if(arr.length){ const item = arr[arr.length-1]; promptEl.value = item.prompt||''; applyTextureFromDataURL(currentModel.designMat, item.dataURL); indexBox.value = `${arr.length} / ${arr.length}`; prevBtn.disabled = arr.length<=1; nextBtn.disabled = true; dlBtn.disabled = false; } else { indexBox.value = `0 / 0`; prevBtn.disabled = true; nextBtn.disabled = true; dlBtn.disabled = true; } }

    // ====== SELECTORS ======
    function initSelectors(){
      typeSel.innerHTML = Object.keys(CATALOG).map(t=>`<option value="${t}">${t}</option>`).join('');
      typeSel.value = 'Jackets';
      populateModels();
      typeSel.addEventListener('change', populateModels);
      modelSel.addEventListener('change', ()=> switchModel(modelSel.value));
    }
    function populateModels(){ const t = typeSel.value; const list = CATALOG[t] || []; modelSel.innerHTML = list.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); if(list.length){ switchModel(list[0].id); } else { currentModel = null; colorsGroup.style.display='none'; try{ if(document.activeElement && document.activeElement.dataset && document.activeElement.classList.contains('cp')){ document.activeElement.blur(); } }catch{} indexBox.value = '0 / 0'; prevBtn.disabled = true; nextBtn.disabled = true; dlBtn.disabled = true; if (iframe) iframe.src = 'about:blank'; materialsByName = new Map(); api = null; } }
    function modelById(id){ const t = typeSel.value; const list = CATALOG[t]||[]; return list.find(m=>m.id===id)||null; }

    function switchModel(modelId){ const m = modelById(modelId); if(!m) return; currentModel = m; renderColors(); initViewerForModel(m.uid); }

    // ====== Palette Picker Builder ======
    function createPalettePicker({colors=LIMITED_COLORS, initial, onChange}={}){
      const arr = colors.map(c => ({ n:c.n, v:(c.v[0]==='#'?c.v:'#'+c.v).toUpperCase() }));
      const el = document.createElement('div');
      el.className = 'cp';
      el.innerHTML = `
        <div class="t"><span class="name"></span>
          <span style="display:flex;align-items:center;gap:8px">
            <svg class="c" viewBox="0 0 20 20" width="12" height="12" aria-hidden="true"><path d="M5 8l5 5 5-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <span class="s"></span>
          </span>
        </div>
        <div class="p"></div>`;
      const t=el.querySelector('.t'), nameEl=el.querySelector('.name'), sw=t.querySelector('.s'), p=el.querySelector('.p');
      arr.forEach((c,i)=>{ const d=document.createElement('div'); d.className='i'; d.innerHTML = `<span>${c.n}</span><span class="s" style="background:${c.v}"></span>`; d.onclick=()=>{ sel=i; sync(); closeP(); }; p.appendChild(d); });
      let sel = 0, open=false;
      function sync(){ const c=arr[sel]; nameEl.textContent=c.n; sw.style.background=c.v; el.value=c.v; const detail={name:c.n,value:c.v,index:sel}; el.dispatchEvent(new CustomEvent('colorchange',{detail})); if(onChange) onChange(c.v, detail); }
      function place(){ const r=el.getBoundingClientRect(),vh=innerHeight; const below=vh-r.bottom-8, above=r.top-8; const need=Math.min(220,p.scrollHeight||220); p.classList.toggle('top', below < Math.min(need,140) && above > below); }
      function openP(){ if(open) return; open=true; p.style.display='block'; el.classList.add('open'); place(); addEventListener('pointerdown', outside, true); addEventListener('resize', place); }
      function closeP(){ if(!open) return; open=false; p.style.display='none'; el.classList.remove('open'); removeEventListener('pointerdown', outside, true); removeEventListener('resize', place); }
      function outside(e){ if(!el.contains(e.target)) closeP(); }
      t.onclick = ()=> open ? closeP() : openP();

      // API
      el._picker = {
        setByHex(hex){ const H=(hex||'').toUpperCase(); const idx = arr.findIndex(c=>c.v===H); if(idx>=0){ sel=idx; const prevOn=onChange; onChange=null; sync(); onChange=prevOn; } },
        get value(){ return el.value }
      };

      // Initial value
      if(initial){ el._picker.setByHex(initial); } else { sync(); }

      return el;
    }

    function renderColors(){
      colorsContainer.innerHTML = '';
      const cols = (currentModel && currentModel.colors) || [];
      if(!cols.length){ colorsGroup.style.display='none'; try{ if(document.activeElement && document.activeElement.classList && document.activeElement.classList.contains('cp')){ document.activeElement.blur(); } }catch{} return; }
      colorsGroup.style.display='block';
      cols.forEach((c,i)=>{
        const row = document.createElement('div'); row.className = 'row';
        const lab = document.createElement('label'); lab.textContent = c.label || `Color ${i+1}`; row.appendChild(lab);
        const picker = createPalettePicker({ colors: LIMITED_COLORS, onChange: (hex)=> applyColor(c.material, hex) });
        picker.dataset.material = c.material;
        row.appendChild(picker);
        colorsContainer.appendChild(row);
      });
    }

    // ====== VIEWER ======
    function initViewerForModel(uid){
      const parent = iframe ? iframe.parentNode : null;
      const newIframe = iframe ? iframe.cloneNode() : document.createElement('iframe');
      if(parent){ parent.replaceChild(newIframe, iframe); }
      iframe = newIframe; // update global reference
      window.requestAnimationFrame(()=>{
        materialsByName = new Map(); api = null;
        const client = new Sketchfab('1.12.1', newIframe);
        client.init(uid, {
          autostart: 1, preload: 1, dnt: 1, camera: 0, transparent: 1, ui_controls: 1,
          ui_infos: 0, ui_help: 0, ui_settings: 0, ui_inspector: 0, ui_ar: 0, ui_vr: 0, ui_annotations: 0, ui_animations: 0, ui_stop: 0,
          ui_watermark: 0, ui_watermark_link: 0,
          success: function(apiHandle){
            api = apiHandle; api.start();
            api.addEventListener('viewerready', function(){
              if(api.setBackground){ api.setBackground({ transparent:true, color:[0,0,0,0] }, function(){}); }
              api.getMaterialList(function(err, mats){
                if(err){ console.warn('getMaterialList error', err); return; }
                materialsByName.clear(); mats.forEach(m=> materialsByName.set(m.name, m));
                // Sync palette pickers to current material colors
                Array.from(colorsContainer.querySelectorAll('.cp')).forEach(el=>{
                  const mat = findMaterial(el.dataset.material);
                  if(mat){ const ch= (mat.channels||{})[baseColorChannel(mat)]||{}; if(Array.isArray(ch.color)){ el._picker.setByHex(rgbNormToHex(ch.color)); }
                  }
                });
                hydrateLatest();
              });
            });
          },
          error: function(){ console.error('Sketchfab init failed'); }
        });
      });
    }

    // ====== COLOR APPLY ======
    function applyColor(matName, hex){ const mat = findMaterial(matName); if(!api || !mat) return; const channel = baseColorChannel(mat); const rgb = hexToRGBNorm(hex); mat.channels = Object.assign({}, mat.channels); const ch = Object.assign({}, mat.channels[channel]||{}); ch.enable = true; ch.factor = ch.factor ?? 1; ch.color = rgb; if('texture' in ch) delete ch.texture; mat.channels[channel] = ch; api.setMaterial(mat, function(err){ if(err) console.warn('setMaterial color error', err); }); }

    // ====== GENERATION ======
    async function doGenerate(){ const userPrompt = (promptEl.value||'').trim(); if(!userPrompt){ clearError(); showError('Enter a prompt first'); return; } const finalPrompt = PREPROMPT ? `${PREPROMPT}\n\n${userPrompt}` : userPrompt; clearError(); const prevText = genBtn.textContent; genBtn.textContent = 'Generating…'; genBtn.classList.add('button--loading'); genBtn.setAttribute('aria-busy','true'); genBtn.disabled = true; prevBtn.disabled = true; nextBtn.disabled = true;  try{ const j = await tryStartGeneration(finalPrompt); const dataURL = j.dataUrl ? j.dataUrl : await fetchAsDataURL(j.url||j.imageUrl); await applyTextureFromDataURL(currentModel.designMat, dataURL); const item = pushHistoryItem(userPrompt, dataURL);  } catch(e){ console.error(e); showError((e && e.message) ? e.message : 'Error'); } finally{ genBtn.textContent = prevText; genBtn.classList.remove('button--loading'); genBtn.removeAttribute('aria-busy'); genBtn.disabled = false; const arr = loadHistory(); prevBtn.disabled = arr.length<=1; nextBtn.disabled = true; dlBtn.disabled = arr.length===0; } }

    async function tryStartGeneration(prompt){ const baseResp = await fetch(BASE_IMAGE_URL, { cache:'no-store' }); if(!baseResp.ok) throw new Error(`Failed to load base image (${baseResp.status})`); const baseBlob = await baseResp.blob(); const fd = new FormData(); fd.append('prompt', prompt); fd.append('size', '1024x1024'); fd.append('user_id', (localStorage.getItem('vd_user')||'anon')); fd.append('image', baseBlob, 'base.png'); const resp = await fetch(`${API_BASE}/api/generate-gemini`, { method:'POST', body: fd }); if(!resp.ok){ let t=''; try{t=await resp.text();}catch{} throw new Error(`${resp.status} ${resp.statusText} ${t}`.trim()); } const data = await resp.json(); const b64 = data?.data?.[0]?.b64_json; if(!b64) throw new Error('Backend OK but returned no image data'); return { dataUrl: `data:image/png;base64,${b64}` }; }

    async function fetchAsDataURL(url){ const r = await fetch(url,{cache:'no-store'}); const b = await r.blob(); return await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b); }); }

    async function applyTextureFromDataURL(matName, dataURL){ const mat = findMaterial(matName); if(!api || !mat) throw new Error('Material not available'); return new Promise((resolve,reject)=>{ api.addTexture(dataURL, function(err, texUid){ if(err){ reject(err); return; } const chName = baseColorChannel(mat); mat.channels = Object.assign({}, mat.channels); const ch = Object.assign({}, mat.channels[chName]||{}); ch.enable=true; ch.factor=ch.factor??1; ch.texture={uid:texUid}; ch.color=[1,1,1]; mat.channels[chName]=ch; api.setMaterial(mat, function(e){ if(e) reject(e); else resolve(); }); }); }); }

    function pushHistoryItem(prompt, dataURL){ const arr = loadHistory(); const item = { id: crypto.randomUUID(), n: arr.length + 1, prompt, dataURL, createdAt: Date.now() }; arr.push(item); saveHistory(arr); updateIndexFromArr(arr); return item; }

    // Buttons
    genBtn.addEventListener('click', ()=>{ doGenerate(); });
    prevBtn.addEventListener('click', ()=>{ const arr = loadHistory(); if(arr.length>1){ const curr = Math.max(1, parseInt(indexBox.value.split('/')[0])||arr.length); const target = Math.max(1, curr-1); applyHistoryIndex(target); } });
    nextBtn.addEventListener('click', ()=>{ const arr = loadHistory(); if(arr.length>1){ const curr = Math.max(1, parseInt(indexBox.value.split('/')[0])||arr.length); const target = Math.min(arr.length, curr+1); applyHistoryIndex(target); } });
    dlBtn.addEventListener('click', ()=>{ const arr=loadHistory(); if(!arr.length) return; const curr = Math.max(1, parseInt(indexBox.value.split('/')[0])||arr.length); const item = arr[curr-1]; const a = document.createElement('a'); const name = `${currentModel?.id||'model'}_design_${item.n}.png`; a.href = item.dataURL; a.download = name; document.body.appendChild(a); a.click(); a.remove(); });

    // Boot
    initSelectors();
  </script>
</body>
</html>
