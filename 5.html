<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sketchfab 3D Configurator — Single‑Model v10</title>
  <style>
    :root{ --bg:#070b14; --panel:#0d1426; --panel-2:#0b1120; --text:#e8ecf6; --muted:#9aa5b3; --accent:#7dd3fc; --border:#1a2444 }
    *{box-sizing:border-box}
    html,body{height:100%; overflow:hidden}
    body{margin:0;background:radial-gradient(1200px 800px at 15% -10%, rgba(96,165,250,.12), transparent),
                     radial-gradient(1200px 800px at 110% 110%, rgba(125,211,252,.10), transparent),
                     var(--bg);color:var(--text);font:15px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;height:100vh}
    .panel{height:100vh;overflow-y:auto;padding:20px 16px 24px;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-left:1px solid var(--border)}
    .panel h1{margin:0 0 10px;font-size:18px;letter-spacing:.2px}
    .group{border:1px solid var(--border);border-radius:16px;padding:12px 12px 14px;margin:12px 0;background:#0b1326}
    .group h2{font-size:13px;color:var(--muted);margin:0 0 10px;font-weight:600;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center;margin:12px 0}
    label{min-width:92px;color:var(--muted)}
    input[type="file"]{width:100%}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .viewer{height:100vh}
    iframe{width:100%;height:100%;border:0;border-left:1px solid var(--border);background:transparent}

    /* Minimal color box that opens native palette on click */
    input[type="color"].colorBox{
      -webkit-appearance: none; appearance: none;
      border:1px solid var(--border); border-radius:6px; width:48px; height:28px; padding:0; background:#ffffff; cursor:pointer;
    }
    input[type="color"].colorBox::-webkit-color-swatch-wrapper{ padding:0 }
    input[type="color"].colorBox::-webkit-color-swatch{ border:none; border-radius:6px }
    .disabled{opacity:.45; pointer-events:none}
  </style>
</head>
<body>
  <!-- CONFIG: edit materials here (model UID is hard‑wired in client.init()) -->

  <div class="wrap">
    <div class="panel">
      <h1>3D Configurator</h1>

      <div class="group">
        <h2>Design</h2>
        <div class="row"><label for="texFile">Upload texture</label><input id="texFile" type="file" accept="image/*" /></div>
        <div class="hint">Upload targets the configured design material.</div>
      </div>

      <div class="group">
        <h2>Colors</h2>
        <div class="row">
          <label>Color 1</label>
          <input id="c1Input" class="colorBox" type="color" value="#ffffff" />
        </div>
        <div class="row">
          <label>Color 2</label>
          <input id="c2Input" class="colorBox" type="color" value="#ffffff" />
        </div>
        <div class="hint">Click the white box to open the native palette. Picking a color clears texture on that material.</div>
      </div>
    </div>

    <div class="viewer">
      <iframe id="api-frame" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="about:blank"></iframe>
    </div>
  </div>

  <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
  <script>
    // ====== CONFIG (materials only) ======
    const DESIGN_MATERIAL  = 'Giacca1_FRONT_2563';          // texture target
    const COLOR1_MATERIAL  = 'Contrasto_FRONT_2545';        // Color 1
    const COLOR2_MATERIAL  = '';                            // Color 2 (set to enable)
    // ====== /CONFIG ======

    // DOM
    const iframe = document.getElementById('api-frame');
    const texFile = document.getElementById('texFile');
    const c1Input  = document.getElementById('c1Input');
    const c2Input  = document.getElementById('c2Input');

    // State
    let api = null;
    const materialsByName = new Map();

    // Utils
    const norm = s => (s||'').trim().toLowerCase();
    function findMaterial(name){
      if(!name) return null;
      const exact = materialsByName.get(name); if(exact) return exact;
      const lname = norm(name);
      for(const [k,v] of materialsByName){ if(norm(k)===lname) return v; }
      for(const [k,v] of materialsByName){ if(norm(k).includes(lname)) return v; }
      return null;
    }
    function hexToRGBNorm(hex){ const h = hex.replace('#',''); const i = parseInt(h,16); return [((i>>16)&255)/255, ((i>>8)&255)/255, (i&255)/255]; }
    function rgbNormToHex(arr){ const toHex = v => ('0'+Math.max(0,Math.min(255,Math.round(v*255))).toString(16)).slice(-2); return `#${toHex(arr[0]||0)}${toHex(arr[1]||0)}${toHex(arr[2]||0)}`; }
    function baseColorChannel(mat){ const ch = mat.channels||{}; return ch.AlbedoPBR?'AlbedoPBR': ch.DiffusePBR?'DiffusePBR': ch.DiffuseColor?'DiffuseColor': ch.BaseColor?'BaseColor': ch.AlbedoColor?'AlbedoColor':'AlbedoPBR'; }

    // Viewer init
    (function initViewer(){
      const client = new Sketchfab('1.12.1', iframe);
      client.init('eea360f7606149deaf75345b1df3f519', {
        autostart: 1, preload: 1, dnt: 1, camera: 0, transparent: 1, ui_controls: 1,
        ui_infos: 0, ui_help: 0, ui_settings: 0, ui_inspector: 0, ui_ar: 0, ui_vr: 0, ui_annotations: 0, ui_animations: 0, ui_stop: 0,
        ui_watermark: 0, ui_watermark_link: 0,
        success: function(apiHandle){
          api = apiHandle; api.start();
          api.addEventListener('viewerready', function(){
            if(api.setBackground){ api.setBackground({ transparent:true, color:[0,0,0,0] }, function(){}); }
            api.getMaterialList(function(err, mats){
              if(err){ console.warn('getMaterialList error', err); return; }
              materialsByName.clear(); mats.forEach(m=> materialsByName.set(m.name, m));
              setupColor(COLOR1_MATERIAL, c1Input);
              if(COLOR2_MATERIAL){ setupColor(COLOR2_MATERIAL, c2Input); } else { c2Input.classList.add('disabled'); c2Input.disabled = true; }
            });
          });
        },
        error: function(){ console.error('Sketchfab viewer failed to init'); }
      });
    })();

    function setupColor(matName, inputEl){
      const mat = findMaterial(matName);
      if(!mat){ inputEl.classList.add('disabled'); inputEl.disabled = true; return; }
      inputEl.disabled = false;

      // init with current material color if present
      const chName = baseColorChannel(mat);
      const ch = (mat.channels||{})[chName] || {};
      inputEl.value = Array.isArray(ch.color) ? rgbNormToHex(ch.color) : '#ffffff';

      const onPick = ()=> applyColor(matName, inputEl.value);
      inputEl.addEventListener('input', onPick);
      inputEl.addEventListener('change', onPick);
    }

    // Apply solid color (remove texture) — full material update for reliability
    function applyColor(matName, hex){
      const mat = findMaterial(matName); if(!api || !mat) return;
      const channel = baseColorChannel(mat);
      const rgb = hexToRGBNorm(hex);
      mat.channels = Object.assign({}, mat.channels);
      const ch = Object.assign({}, mat.channels[channel]||{});
      ch.enable = true; ch.factor = ch.factor ?? 1; ch.color = rgb; if('texture' in ch) delete ch.texture;
      mat.channels[channel] = ch;
      api.setMaterial(mat, function(err){ if(err) console.warn('setMaterial color error', err); });
    }

    // Texture upload → DESIGN_MATERIAL only
    texFile.addEventListener('change', function(){
      if(!this.files || !this.files[0]) return; const mat = findMaterial(DESIGN_MATERIAL); if(!mat){ console.warn('Design material not found'); return; }
      const file = this.files[0]; const img = new Image(); const url = URL.createObjectURL(file);
      img.onload = function(){
        try{
          const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight;
          const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
          const dataURL = c.toDataURL('image/png');
          api.addTexture(dataURL, function(err, texUid){
            if(err){ console.warn('addTexture error', err); return; }
            const channel = baseColorChannel(mat);
            mat.channels = Object.assign({}, mat.channels);
            const ch = Object.assign({}, mat.channels[channel]||{});
            ch.enable = true; ch.factor = ch.factor ?? 1; ch.texture = { uid: texUid }; ch.color = [1,1,1];
            mat.channels[channel] = ch;
            api.setMaterial(mat, function(e){ if(e) console.warn('setMaterial tex error', e); });
          });
        } finally { URL.revokeObjectURL(url); texFile.value = ''; }
      }; img.src = url;
    });
  </script>
</body>
</html>

